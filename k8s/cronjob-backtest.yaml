apiVersion: batch/v1
kind: CronJob
metadata:
  name: market-nightly-backtest
spec:
  schedule: "0 2 * * *"  # 2:00 AM UTC
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: market-sa
          securityContext:
            runAsUser: 10001
            runAsGroup: 10001
            fsGroup: 10001
            runAsNonRoot: true
          containers:
          - name: worker
            image: ghcr.io/adhithyasash1/testing:main
            imagePullPolicy: Always
            command: ["python", "-m", "src.run_backtest_cli", "--days", "300"]
            resources:
              requests:
                cpu: "1000m"
                memory: "2Gi"
              limits:
                cpu: "2000m"
                memory: "4Gi"
            env:
              - name: ARTIFACT_BUCKET
                valueFrom:
                  secretKeyRef:
                    name: market-secrets
                    key: ARTIFACT_BUCKET
                    optional: true
          restartPolicy: OnFailure
          imagePullSecrets:
          - name: ghcr-secret
